<?php
/*
 * @Author: ZHOU MEILEI
 * @CreateBy: Visual studio code 
 * @Date: 2019-10-10 13:08:12 
 * @Last Modified by: ZHOU MEILEI
 * @Last Modified time: 2019-10-10 13:18:43
 */

namespace app\api\model;

use app\api\lib\Exception\IDPasswordException;
use app\api\lib\Exception\PasswordEasyException;
use app\api\lib\Exception\MissException;

/**
 * 模拟登陆
 * Class Login
 * @package app\api\model
 */
class Login
{
    public function doLogin($studentID, $password)
    {

        $moreMsg = $this->firstLogin($studentID, $password);
        return $moreMsg;
    }


    /**
     * 首次登录并判断是否登录成功
     * @param $studentID 学号
     * @param $password 密码
     * @param $cookie
     * @return mixed 同学姓名
     * @throws IDPasswordException
     * @throws PasswordEasyException
     */
    public function firstLogin($studentID, $password)
    {
        // 获取教务系统cookie
        $page = (new Utils())->curlLoginJW('https://jw.webvpn.jxust.edu.cn', '', '');
        // var_dump($page);exit;
        $cookieJw = (new GetCookie())->getNewJwCookie($page);
        // echo $cookieJw;exit;
        $url = "https://jw.jxust.edu.cn/Logon.do?method=logon";
        // $this->picCurl("http://jw.jxust.edu.cn/verifycode.servlet", $cookie);
        // var_dump($photos);
        $RANDOMCODE = '';
        // 识别验证码
        $RANDOMCODE = $this->getHec('https://jw.jxust.edu.cn/verifycode.servlet', 0, $cookieJw);
        // 账号与密码的对称加密
        $encodedSource = $this->getEncoded($studentID, $password, $cookieJw);
        $encoded = $encodedSource[0];
        $cookieJw = $cookieJw . $encodedSource[1];
        // echo $RANDOMCODE;exit;
        // var_dump($RANDOMCODE); exit;
        $post = [
            'userAccount' => $studentID,
            'userPassword' => '',
            'RANDOMCODE' => $RANDOMCODE,
            'encoded' => $encoded
        ];
        //将数组转换成字符串
        $post = http_build_query($post);
        // 模拟登陆请求发送
        $page = (new Utils())->curl($url, $post, $cookieJw);
        if (strpos($page, "密码错误")) {
            throw new IDPasswordException();
        }
        // echo($cookieJw . "<br>");
        // echo $RANDOMCODE;
        // echo($page); exit;
        if (strpos($page, '/framework/userInfo_edit.jsp')) {
            throw new PasswordEasyException();
        }
        $url = (new Utils())->getLocation($page);
        
        $page = (new Utils())->curlOther($url[2][0], '', $cookieJw);
        if (strpos($page, 'value="修改密码')) {
            throw new PasswordEasyException();
        }
        // var_dump($page);exit;
        $cookieJw = $cookieJw . (new GetCookie())->curlCookie($page);
        $url = (new Utils())->getLocation($page);
        // $cookieJw = $cookieJw . (new GetCookie())->curlCookie($page);
        $page = (new Utils())->curlOther($url[2][0], '', $cookieJw);
        // echo($page);exit;
        // // $url = (new Utils())->getLocation($page);
        // $cookieJw = $cookieJw . (new GetCookie())->curlCookie($page);
        // $page = (new Utils())->curlOther($url[2][0], '', $cookieJw);
        // $url = (new Utils())->getLocation($page);
        // // $cookieJw = $cookieJw . (new GetCookie())->curlCookie($page);
        // $page = (new Utils())->curlOther($url[2][0], '', $cookieJw);
        preg_match_all(
            '/<span class="glyphicon-class">([^<>\n]+)/',
            $page,
            $name
        );
        // echo($page);exit;
        if (empty($name[1][0])) {
            //正则匹配——用户名或密码错误
            preg_match_all('/<li class="input_li" id="showMsg" style="color: red; margin-bottom: 0;">
                        \&nbsp;([^<>\n]+)/', $page, $msg);
            if (empty($msg[1])) {
                // echo $result;
                // preg_match_all('/<font color="blue"><b>([^<>\n]+)/', $result, $msg);
                if (strpos($page, 'value="修改密码')) {
                    throw new PasswordEasyException();
                }
            } else {
                throw new IDPasswordException();
            }
        }
        //得到同学的名字
        if (count($name[1]) > 0) {
            $moreMsg = (new Utils())->getMoreMsg($cookieJw);
            $moreMsg['cookieEha'] = '';
        } else {
            throw new MissException(['code' => 505, 'msg' => '基础信息获取异常', 'errorCode' => 999]);
        }
        return $moreMsg;
    }

    /**
     * 在登录成功后在另一个页面抓取更详细信息
     * @param $cookie
     * @return array
     */
    // 函数已失效，已换成Utils里面的getMoreMsg
    protected function getMoreMsg($cookie)
    {

        $url = "http://172.16.2.39/jsxsd/framework/xsMain_new.jsp";
        $result = $this->loginCurl($url, "", $cookie);
        preg_match_all('/<div class="middletopdwxxcont">([^<>\n]+)/', $result, $msg);
        $msg = [
            "name" => $msg[1][1],
            "studentID" => $msg[1][2],
            "school" => $msg[1][3],
            "profession" => $msg[1][4],
            "class" => $msg[1][5]
        ];
        return $msg;
    }

    // 获取带网络头的图片
    public function picCurl($url, $cookie)
    {
        $filename = "image.jpg";
        $url = str_replace('.webvpn', '', $url);
        $url = str_replace('http:', 'https:', $url);
        // $url = str_replace('http://jw.jxust.edu.cn','http://jw.webvpn.jxust.edu.cn', $url);
        // $url = str_replace('http://jw.webvpn.jxust.edu.cn','http://jw.zhoumeilei.cn', $url);
        // $url = str_replace('http://authserver.webvpn.jxust.edu.cn/','http://auth.zml123.top', $url);
        // $url = str_replace('http://jw.jxust.edu.cn', 'http://jw.zhoumeilei.cn', $url);
        // $url = str_replace('http://authserver.jxust.edu.cn/','http://auth.zml123.top', $url);
        # 文件下载 BEGIN #
        // 打开临时文件，用于写入（w),b二进制文件
        // $resource = fopen($tmpFile, 'wb');
        // $resource = '';
        $fp = fopen($filename, 'wb');
        $curl = curl_init();
        // 设置输出文件为刚打开的
        curl_setopt($curl, CURLOPT_URL, $url);
        curl_setopt($curl, CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)
         AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36');
        curl_setopt($curl, CURLOPT_FILE, $fp);
        curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, FALSE); // https请求 不验证证书和hosts
        curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, FALSE);
        // 不需要头文件
        curl_setopt(
            $curl,
            CURLOPT_REFERER,
            'https://jw.jxust.edu.cn/'
        );
        curl_setopt($curl, CURLOPT_HEADER, 0);
        curl_setopt($curl, CURLOPT_COOKIE, $cookie);
        curl_setopt($curl, CURLOPT_FOLLOWLOCATION, 1);
        curl_setopt($curl, CURLOPT_TIMEOUT, 60);
        curl_exec($curl);
        curl_close($curl);
        fclose($fp);
    }


    public function loginCurl($url, $post, $cookie)
    {
        $url = str_replace('.webvpn', '', $url);
        $url = str_replace('http:', 'https:', $url);
        // $url = str_replace('http://jw.jxust.edu.cn','http://jw.webvpn.jxust.edu.cn', $url);
        // $url = str_replace('http://jw.webvpn.jxust.edu.cn','http://jw.zhoumeilei.cn', $url);
        // $url = str_replace('http://authserver.webvpn.jxust.edu.cn/','http://auth.zml123.top', $url);
        // $url = str_replace('http://jw.jxust.edu.cn', 'http://jw.zhoumeilei.cn', $url);
        // $url = str_replace('http://authserver.jxust.edu.cn/','http://auth.zml123.top', $url);
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)
         AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36');
        curl_setopt($ch, CURLOPT_HEADER, 1);
        //不自动输出数据，要echo才行
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_AUTOREFERER, 1);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE); // https请求 不验证证书和hosts
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE);
        curl_setopt($ch, CURLOPT_COOKIE, $cookie);
        //重要，302跳转需要referer，可以在Request Headers找到
        curl_setopt(
            $ch,
            CURLOPT_HTTPHEADER,
            [
                'Referer: https://jw.jxust.edu.cn/sso.jsp',
                'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8',
            ]
        );
        //TRUE 时会发送 POST 请求，类型为：application/x-www-form-urlencoded，是 HTML 表单提交时最常见的一种
        curl_setopt($ch, CURLOPT_POST, 1);
        //post提交数据
        curl_setopt($ch, CURLOPT_POSTFIELDS, $post);
        $result = curl_exec($ch);
        curl_close($ch);
        return $result;
    }


    // 加密函数 2019/7/6 rebuilt by zhoumeilei
    public function getEncoded($studentID, $password, $cookie)
    {
        $dataStrSource = $this->loginCurl('https://jw.webvpn.jxust.edu.cn/Logon.do?method=logon&flag=sess', '', $cookie);
        $dataStr = explode("\r\n\r\n", $dataStrSource)[1];
        $cookieRes = (new GetCookie())->curlCookie($dataStrSource);
        // $dataStr = '5s1nxcJ2iH23e5M84923vOCmrb55r0d0yY742F28A#32222312113323211313';
        if ($dataStr == 'no') {
            throw new MissException(['code' => 502, 'msg' => '服务器异常', 'errorCode' => 999]);
        } else {
            $data = explode('#', $dataStr);
            $scode = $data[0];
            $sxh = $data[1];
            $code = $studentID . '%%%' . $password;
            // echo substr($code, 0, 0);
            // echo substr($code, 1, 1);
            $encoded = '';
            // echo strlen($sxh);
            for ($i = 0; $i < strlen($code); $i++) {
                if ($i < 20) {
                    // var_dump((int)substr($sxh, $i, 1));
                    $encoded = $encoded . $this->cutStr($code, $i, $i + 1) . $this->cutStr($scode, 0, (int) substr($sxh, $i, 1));
                    $scode = $this->cutStr($scode, ((int) substr($sxh, $i, 1)), strlen($scode));
                    // var_dump($encoded);
                } else {
                    $encoded = $encoded . $this->cutStr($code, $i, strlen($code));
                    $i = strlen($code);
                    // var_dump($encoded);
                }
            }
            return [$encoded, $cookieRes];
        }
        // $enCoded = $this->encodeInp($str1) . "%%%" . $this->encodeInp($str2);
        // return $enCoded;
    }

    // 截取字符串的函数
    public function cutStr($str, $start, $end)
    {
        if ($end < strlen($str)) {
            // $end = strlen($str);
            $str_0 = substr($str, $start, ($end - strlen($str)));
        } else {
            $str_0 = substr($str, $start);
        }
        return $str_0;
    }

    // 识别验证码 2019/7/6 createed by zhoumeilei
    public function getHec($imagePath, $num, $cookie)
    {
        $this->picCurl($imagePath . "?t=0.11357278573754481", $cookie);
        $pic_1 = [];
        $res = imagecreatefromjpeg('image.jpg');
        $k = 0;
        $pic = [];
        $pic_1[0] = '';
        $pic_1[1] = '';
        $pic_1[2] = '';
        $pic_1[3] = '';
        for ($i = 1, $m = 0; $i < 39; $i++) {
            for ($j = 1; $j < 79; $j++) {
                $rgb = imagecolorat($res, $j, $i);
                $rgbarray = imagecolorsforindex($res, $rgb);
                if ($rgbarray['red'] < 60 || $rgbarray['green'] < 100 || $rgbarray['blue'] < 100) {
                    // echo "0";
                    $pic[$m][$k++] = '0';
                } else {
                    // echo "1";
                    $pic[$m][$k++] = '1';
                }
            }
            $m++;
            $k = 0;
        }
        $coeds = [];
        for ($i = 0; $i < count($pic[0]); $i++) {
            for ($j = 0; $j < count($pic); $j++) {
                $codes[$i][$j] = $pic[$j][$i];
            }
        }
        for ($i = 1, $falg = 0, $row = 0; $i < count($codes) - 1; $i++) {
            if ($row > 3) {
                break;
            }
            if ($falg && (!in_array('0', $codes[$i]))) {
                $row++;
                $falg = 0;
                continue;
            }
            for ($j = 0; $j < count($codes[$i]); $j++) {
                if ($j == count($codes[$i]) - 1) {
                    if ($falg) $pic_1[$row] = $pic_1[$row] . '1';
                    continue;
                }
                if ($codes[$i][$j] == '0' && ($i != 0) && ($j != 0)) {
                    if (($codes[$i + 1][$j] == '0') || ($codes[$i - 1][$j] == '0') || ($codes[$i][$j + 1] == '0') || ($codes[$i][$j - 1] == '0')) {
                        $pic_1[$row] = $pic_1[$row] . '0';
                        $falg = 1;
                    } else {
                        if ($falg)  $pic_1[$row] = $pic_1[$row] . '1';
                        // $pic_1[$row] = $pic_1[$row] . '1';
                    }
                } else {
                    if ($falg)  $pic_1[$row] = $pic_1[$row] . '1';
                }
                // echo $pic[$j][$i];
            }
            // echo "<br>";
        }

        $source = [
            [
                'value' => 'a', 'code' => [
                    '00001111111111111111111111111111001110000001111111111111111111111111100111100000001111111111111111111111111001110001110011111111111111111111111110011100111100111111111111111111111111100111001111001111111111111111111111111000110011100111111111111111111111111110000000000001111111111111111111111111110000000000001111111111111111111111111110000000000011111111111111111111111111111111111100',
                    '',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => 'b', 'code' => [
                    '000000000000000000011111111111100111111111111111111111111111111111111001111111111111100111111111111111111110011111111111000001111111111111111111100111111111000000011111111111111111111001111111100000111111111111111111111110011111100001111111111111111111111111100111100001111111111111111111111111111001110001111111111111111111111111111110010000111111111111111111111111111111100000111111111111111111111111111111111000011111111111111111111111111111111110001111111111111111111111111111111110000000000000000000111111111111111111100000000000000000001111111111111111111111111100111111100111111111111111111111111110001111111100111111111111111111111111100111111111001111111111111111111111111001111111110011111111111111111111111110011111111100111111111111111111111111100111111110001111111111111111111111111000011111000011111111111111111111111111000000000001111111111111111111111111111000000000111111111111111111111111111111000000',
                    '0000000000000000000111111111111111111100000000000000000001111111111111111111000000000000000000011111111111111111111111111001111111001111111111111111111111111110001111111100111111111111111111111111100111111111001111111111111111111111111001111111110011111111111111111111111110011111111100111111111111111111111111100111111110001111111111111111111111111000011111000011111111111111111111111111000000000001111111111111111111111111111000000000111111111111111111111111111111000000',
                    '000000000000000000011111111111111111110000000000000000000111111111111111111100000000000000000001111111111111111111111111100111111100111111111111111111111111110001111111100111111111111111111111111100111111111001111111111111111111111111001111111110011111111111111111111111110011111111100111111111111111111111111100111111110001111111111111111111111111000011111000011111111111111111111111111000000000001111111111111111111111111111000000000111111111111111111111111111111000000',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => 'c', 'code' => [
                    '0000011111111111111111111111111111110000000001111111111111111111111111111000000000001111111111111111111111111110001111100011111111111111111111111111000111111100011111111111111111111111110011111111100111111111111111111111111100111111111001111111111111111111111111001111111110011111111111111111111111110011111111100111111111111111111111111100111111111001111111111111111111111111100111111100',
                    '00000111111111111111111111111111111100000000011111111111111111111111111110000000000011111111111111111111111111110001111100011111111111111111111111111000111111100011111111111111111111111110011111111100111111111111111111111111100111111111001111111111111111111111111001111111110011111111111111111111111110011111111100111111111111111111111111100111111111001111111111111111111111111100111111100',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => 'd', 'code' => [
                    '000000111111111111111111111111111111000000000111111111111111111111111111100000000000111111111111111111111111110000111110000111111111111111111111111100011111111001111111111111111111111111001111111110011111111111111111111111110011111111100111111111111111111111111100111111111001111111111111111111111111001111111100111111111111111111111111111001111111001111111111111111111100000000000000000001111111111111111111000000000000000000011111111111111111110000000000000000000',
                    '',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => 'e', 'code' => [
                    '000001111111111111111111111111111111000000000111111111111111111111111111100000000000111111111111111111111111111001100110001111111111111111111111111100111001111001111111111111111111111111001110011110011111111111111111111111110011100111100111111111111111111111111100111001111001111111111111111111111111000110011110011111111111111111111111111000000111100111111111111111111111111111000001111001111111111111111111111111111000011100',
                    '',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => 'f', 'code' => [
                    '00111111111111111111111111111111111111001111111111111111111111111111111100000000000000000111111111111111111110000000000000000001111111111111111111000000000000000000011111111111111111110001110011111111111111111111111111111100111100111111111111111111111111111111001111001111111111111111111111111111110',
                    '001111111111111111111111111111111111110011111111111111111111111111111111000000000000000001111111111111111111100000000000000000011111111111111111110000000000000000000111111111111111111100011100111111111111111111111111111111001111001111111111111111111111111111110011110011111111111111111111111111111100',
                    '0011111111111111111111111111111111111100111111111111111111111111111111111111000100100100111111111111111111111100111100010010000001111111111111111111000010001001000000111111111111111111110101111011111111111111111111111111111110111100111111111111111111111111111111001111011111111111111111111111111111110',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => 'g', 'code' => [
                    '00000011111111111111111111111111111100000000011110011111111111111111111110000000000011100111111111111111111111000011111000011100111111111111111111110001111111100111001111111111111111111100111111111001110011111111111111111111001111111110011100111111111111111111110011111111100111001111111111111111111110111111110011110011111111111111111111100111111000111001111111111111111111110000000000000000011111111111111111111100000000000000001111111111111111111111000000000000000',
                    '010000001111111111111111111111111111110000000001111001111111111111111111111000000000001110011111111111111111111100001011100001110011111111111111111111000111111110011100111111111111111111110011111111100111001111111111111111111100011111111001110111111111111111111111000111111110011100111111111111111111111011111111001111011111111111111111111110011111100011100111111111111111111111000000000000000001111111111111111111110000000000000000111111111111111111111100000000000000',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => 'h', 'code' => [
                    '00000000000000000001111111111111111111000000000000000000011111111111111111110000000000000000000111111111111111111111111111001111111111111111111111111111111111100111111111111111111111111111111111110011111111111111111111111111111111111100111111111111111111111111111111111111001111111111111111111111111111111111110001111111111111111111111111111111111100000000000001111111111111111111111111100000000000011111111111111111111111111100000000000',
                    '',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => 'i', 'code' => [
                    '0011100000000000001111111111111111111100111000000000000011111111111111111111001110000000000000',
                    '',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => 'j', 'code' => [
                    '0011111111111111111111111111111111111100111111111111111111111111111111111111001111111111111110011100000000000000000011111111111111100111000000000000000001111111111111111001110000000000000000',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => 'k', 'code' => [
                    '010000000000000001111111111111111111100000000000000000001111111111111111111100000100000000000011111111111111111111111111111110111111111111111111111111111111111111000111111111111111111111111111111111100010111111111111111111111111111111110010000111111111111111111111111111111001110000111111111111111111111111111100111110000111111111111111111111111110111111110000111111111111111111111111101111111110001111111111111111111111111111111111110011111111111111111111111111111111111110',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => 'l', 'code' => [
                    '0000000000000000000111111111111111111100000000000000000001111111111111111111000000000000000000011111111111',
                    '',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => 'm', 'code' => [
                    '0000000000000111111111111111111111111100000000000001111111111111111111111111000000000000011111111111111111111111111100111111111111111111111111111111111110011111111111111111111111111111111111001111111111111111111111111111111111110011111111111111111111111111111111111100011111111111111111111111111111111111000000000000011111111111111111111111111000000000000111111111111111111111111110000000000001111111111111111111111111110011111111111111111111111111111111111001111111111111111111111111111111111100111111111111111111111111111111111111001111111111111111111111111111111111110001111111111111111111111111111111111100000000000001111111111111111111111111000000000000011111111111111111111111111000000000000',
                    '00000000000001111111111111111111111111000000000000011111111111111111111111110000000000000111111111111111111111111111001111111111111111111111111111111111100111111111111111111111111111111111110011111111111111111111111111111111111100111111111111111111111111111111111111000111111111111111111111111111111111110000000000000111111111111111111111111110000000000001111111111111111111111111100000000000011111111111111111111111111100111111111111111111',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => 'n', 'code' => [
                    '0000000000000111111111111111111111111100000000000001111111111111111111111111000000000000011111111111111111111111111100111111111111111111111111111111111110011111111111111111111111111111111111001111111111111111111111111111111111110011111111111111111111111111111111111100111111111111111111111111111111111111000111111111111111111111111111111111110000000000000111111111111111111111111110000000000001111111111111111111111111110000000000011111111111',
                    '',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => 'o', 'code' => [
                    '',
                    '',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => 'p', 'code' => [
                    '000000000000000000111111111111111111110000000000000000001111111111111111111100000000000000000011111111111111111111100111111100111111111111111111111111110001111111101111111111111111111111111100111111111001111111111111111111111111001111111110011111111111111111111111110011111111100111111111111111111111111100111111110001111111111111111111111111000011111000011111111111111111111111111000000000001111111111111111111111111111000000000111111111111111111111111111111000000111111111111111',
                    '',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => 'q', 'code' => [
                    '00000011111111111111111111111111111100000000011111111111111111111111111110000000000011111111111111111111111111000011111000011111111111111111111111110001111111100111111111111111111111111100111111111001111111111111111111111111001111111110011111111111111111111111110011111111100111111111111111111111111100111111110011111111111111111111111111100111111100111111111111111111111111110000000000000000001111111111111111111100000000000000000011111111111111111111000000000000000000111111',
                    '00000011111111111111111111111111111100000000011111111111111111111111111110000000000011111111111111111111111111000011111000011111111111111111111111110001111111100111111111111111111111111100111111111001111111111111111111111111001111111110011111111111111111111111100011111111100111111111111111111111111100111111110011111111111111111111111111100111111100111111111111111111111111110000000000000000001111111111111111111100000000000000000011111111111111111111000000000000000000111111',
                    '00000011111111111111111111111111111100000000011111111111111111111111111110000000000011111111111111111111111111000011111000011111111111111111111111110001111111100111111111111111111111111100111111111001111111111111111111111111001111111110011111111111111111111111110011111111100111111111111111111111111100111111110011111111111111111111111111100111111100111111111111111111111111110000000000000000001111111111111111111100000000000000000011111111111111111111000000000000000001111111',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => 'r', 'code' => [
                    '00000000000001111111111111111111111111000000000000011111111111111111111111110000000000000111111111111111111111111111001111111111111111111111111111111111100111111111111111111111111111111111110011111111111111111111111111111111111100111111111111111111111111111111111111001111111111111111111111',
                    '',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => 's', 'code' => [
                    '0001111100111111111111111111111111111000001111000111111111111111111111111100000001111001111111111111111111111111001100011110011111111111111111111111110011100011100111111111111111111111111100111000111001111111111111111111111111001110000110011111111111111111111111110011110000001111111111111111111111111110011100000011111111111111111111111111111111100001111111111111',
                    '0001111100111111111111111111111111111000011111000111111111111111111111111100001001111101111111111111111111111111001100011110011111111111111111111111110111100011101111111111111111111111111100111010111101111111111111111111111111001110000110011111111111111111111111110111110000001111111111111111111111111110011110000011111111111111111111111111111111110001111111111111',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => 't', 'code' => [
                    '001111111111111111111111111111111110000000000000011111111111111111111111100000000000000011111111111111111111111000000000000000011111111111111111111111110011111111000111111111111111111111111100111111111001111111111111111111111111001111111110011111111111',
                    '',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => 'u', 'code' => [
                    '0000000000011111111111111111111111111100000000000011111111111111111111111111000000000000011111111111111111111111111111111111000111111111111111111111111111111111111001111111111111111111111111111111111110011111111111111111111111111111111111100111111111111111111111111111111111110011111111111111111111111111111111111001111111111111111111111111110000000000000111111111111111111111111100000000000001111111111111111111111111000000000000011111111111',
                    '',
                    '000100000001111111111111111111111111110010000000001111111111111111111111111110100000010101111111111111111111111111111111111100011111111111111111111111111111111111100111111111111111111111111111111111111011111111111111111111111111111111111111111111111111',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => 'v', 'code' => [
                    '01111111111111111111111111111111111111000111111111111111111111111111111111110000011111111111111111111111111111111110000000111111111111111111111111111111111000000011111111111111111111111111111111100000001111111111111111111111111111111110000001111111111111111111111111111111111000011111111111111111111111111111111000001111111111111111111111111111111000001111111111111111111111111111111000001111111111111111111111111111111000011111111111111111111111111111111100011111111111111111111111111111111111011111111111111111111111',
                    '00011111111111111111111111111111111111000001111111111111111111111111111111111000100011111111111111111111111111111111110010011111111111111111111111111111111111000001111111111111111111111111111111111000000111111111111111111111111111111111100001111111111111111111111111111111100000111111111111111111111111111111100001111111111111111111111111111111111101011111111111111111111111111111110011111111111111111111111111111111111100111111111111111111111111111111111111011111111111111111111111',
                    '011111111111111111111111111111111111111000111111111111111111111111111111111110000011111111111111111111111111111111110000000111111111111111111111111111111111000000011111111111111111111111111111111100000001111111111111111111111111111111110000001111111111111111111111111111111111000011111111111111111111111111111111000001111111111111111111111111111111000001111111111111111111111111111111000001111111111111111111111111111111000011111111111111111111111111111111100011111111111111111111111111111111111011111111111111111111111',
                    '01111111111111111111111111111111111111000111111111111111111111111111111111110000011111111111111111111111111111111110000000111111111111111111111111111111111100000011111111111111111111111111111111100000001111111111111111111111111111111110000001111111111111111111111111111111111000011111111111111111111111111111111000001111111111111111111111111111111000001111111111111111111111111111111000001111111111111111111111111111111000011111111111111111111111111111111100011111111111111111111111111111111111011111111111111111111111',
                    '',
                    ''
                ]
            ],
            [
                'value' => 'w', 'code' => [
                    '001111111111111111111111111111111111110000001111111111111111111111111111111100000000011111111111111111111111111111110000000000011111111111111111111111111111100000000111111111111111111111111111111111100001111111111111111111111111111111000000011111111111111111111111111111000000111111111111111111111111111110000001111111111111111111111111111111000011111111111111111111111111111111110000000111111111111111111111111111111110000000001111111111111111111111111111111100000000011111111111111111111111111111110000000111111111111111111111111111111111100001111111111111111111111111111110000000011111111111111111111111111000000000111111111111111111111111111100000011111111111111111111111111111111001111111111111111111111',
                    '',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => 'x', 'code' => [
                    '0111111111110111111111111111111111111100111111111001111111111111111111111111000011111100011111111111111111111111110000011100011111111111111111111111111111000000001111111111111111111111111111111000000111111111111111111111111111111111000000111111111111111111111111111111100000000111111111111111111111111111110001110000011111111111111111111111110001111110000111111111111111111111111100111111111001111111111111111111111111011111111111011111111111',
                    '',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => 'y', 'code' => [
                    '011111111111111111111111111111111111110000111111111111101111111111111111111100000001111111110011111111111111111111100000000111111000111111111111111111111111000000001100001111111111111111111111111100000000001111111111111111111111111111111000001111111111111111111111111111111000001111111111111111111111111111111000001111111111111111111111111111110000001111111111111111111111111111110000011111111111111111111111111111111100011111111111111111111111111111111111011111111111111111111111',
                    '',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => 'z', 'code' => [
                    '0011111111000111111111111111111111111100111111100001111111111111111111111111001111110000011111111111111111111111110011111000000111111111111111111111111100111100001001111111111111111111111111001110000110011111111111111111111111110011000011100111111111111111111111111100100001111001111111111111111111111111000000111110011111111111111111111111110000011111100111111111111111111111111100001111111001111111111111111111111111000111111110011111111111',
                    '0011111111000111111111111111111111111100111111100001111111111111111111111111001111110000011111111111111111111111110011111000000111111111111111111111111100111100001001111111111111111111111111001110000110011111111111111111111111110011000011100111111111111111111111111100100001111001111111111111111111111111001000111110011111111111111111111111110000011111100111111111111111111111111100001111111001111111111111111111111111000111111110011111111111',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => '0', 'code' => [
                    '',
                    '',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => '1', 'code' => [
                    '00111111111111100111111111111111111111001111111111111001111111111111111111110011111111111110011111111111111111111000010000000000000111111111111111111110000000000000000001111111111111111111100000000000000000011111111111111111111111111111111111100111111111111111111111111111111111111001111111111111111111111111111111111110011111111111',
                    '00111111111111100111111111111111111111001111111111111001111111111111111111110011111111111110011111111111111111111000000000000000000111111111111111111110000000000000000001111111111111111111100000000000000000011111111111111111111111111111111111100111111111111111111111111111111111111001111111111111111111111111111111111110011111111111',
                    '0011111111111111011111111111111111111100111111111111110111111111111111111111001111111111111001111111111111111111100001010010000010111111111111111111111000000101010010000111111111111111111110000000000000000001111111111111111111111111111111111111011111111111',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => '2', 'code' => [
                    '001111111111110001111111111111111111110011111111111000011111111111111111111001111111111100000111111111111111111110011111111110001001111111111111111111100111111111000110011111111111111111111001111111100011100111111111111111111110011111110001111001111111111111111111100011110000111110011111111111111111111100000000011111100111111111111111111111100000001111111001111111111111111111111100000111111110011111111111',
                    '001111111111110001111111111111111111110111111111111000011111111111111111111101111111111100000111111111111111111110011111111110001001111111111111111111111111111111000110111111111111111111111101111111100011100111111111111111111110011111111001111101111111111111111111100011110000111110011111111111111111111100000000011111100111111111111111111111100000001111111001111111111111111111111100000111111110011111111111',
                    '001111111111111011111111111111111111110111111111111010011111111111111111111001111111111110000111111111111111111110111111111110001001111111111111111111101111111111110110111111111111111111111001111111110011110111111111111111111111011111110101111001111111111111111111100011111101111111011111111111111111111100010010011111110111111111111111111111110101111111111001111111111111111111111111111111111110111111111111',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => '3', 'code' => [
                    '001111111111110011111111111111111111100111111001111100011111111111111111111001111110011111100111111111111111111110011111100111111001111111111111111111100111111001111110011111111111111111111001111100011111100111111111111111111110001110000011111001111111111111111111110000000100011100011111111111111111111100000011000000001111111111111111111111100001111000000111111111111111111111111111111111000011111111111111',
                    '001111111111110011111111111111111111100111111001111100011111111111111111111001111110011111100111111111111111111110011111100111111001111111111111111111100111111001111110011111111111111111111000111100011111100111111111111111111110001110000011111001111111111111111111110000000100011100011111111111111111111100000011000000001111111111111111111111100001111000000111111111111111111111111111111111000011111111111111',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => '4', 'code' => [
                    '000111111111111111111111111111111111100001111111111111111111111111111111100000011111111111111111111111111111110001100111111111111111111111111111111000111001111111111111111111111111111000111110011111111111111111111111111100011111100111111111111111111111111110000000000000000001111111111111111111100000000000000000011111111111111111111000000000000000000111111111111111111111111111111001111111111111111111111111111111111110011111111111111111',
                    '0001111111111111111111111111111111111000011111111111111111111111111111111000000111111111111111111111111111111100011001111111111111111111111111111110001100011111111111111111111111111110001111100111111111111111111111111111100011111100111111111111111111111111110000000000000000001111111111111111111100000000000000000011111111111111111111000000000000000000111111111111111111111111111111001111111111111111111111111111111111110011111111111111111',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => '5', 'code' => [
                    '0000000011111110011111111111111111111100000000111111110011111111111111111111001111001111111100111111111111111111110011110011111111001111111111111111111100111100111111110011111111111111111111001111000111111100111111111111111111110011111001111110001111111111111111111100111110001111000111111111111111111111001111110000000001111111111111111111110011111100000000111111111111111111111100111111110000011111111111111',
                    '',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => '6', 'code' => [
                    '00000000111111111111111111111111111100000000000011111111111111111111111110000000000000011111111111111111111111000011100011100011111111111111111111110011111001111100011111111111111111111000111100111111100111111111111111111110011111001111111100111111111111111111110011111001111111001111111111111111111100111110001111111001111111111111111111100111110000111100111111111111111111111001111110000000001111111111111111111111001111110000000111111111111111111111111111111110000011111111111111',
                    '000000001111111111111111111111111111000000000000111111111111111111111111100000000000000111111111111111111111110000111000111000111111111111111111111100111110011111000111111111111111111110001111001111111001111111111111111111100111110011111110011111111111111111111001111100111111100111111111111111111110011111000111111001111111111111111111101111110000111100111111111111111111111001111110000000001111111111111111111111001111110000000111111111111111111111111111111110000011111111111111',
                    '000000001111111111111111111111111111000000000000111111111111111111111111100000000000000111111111111111111111110000111000111000111111111111111111111100111110011111000111111111111111111110001111001111111001111111111111111111100111110011111110011111111111111111111001111100111111100111111111111111111110011111000111111001111111111111111111100111110000111100111111111111111111111001111110000000001111111111111111111111001111110000000111111111111111111111111111111110000011111111111111',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => '7', 'code' => [
                    '001111111111111111111111111111111111110011111111111111001111111111111111111100111111111110000011111111111111111111001111111110000000111111111111111111110011111111000001111111111111111111111100111111000011111111111111111111111111001111000011111111111111111111111111110011100011111111111111111111111111111100100001111111111111111111111111111111000001111111111111111111111111111111110000111111111111111111111111111111111100011111111111111111111111111',
                    '001111111111111111111111111111111111110111111111111111111111111111111111111110111111111111000011111111111111111111100111111111000000111111111111111111111111111111100000111111111111111111111111011111100001111111111111111111111111100111101001111111111111111111111111111001110001111111111111111111111111111110110000111111111111111111111111111111100000111111111111111111111111111111111000011111111111111111111111111111111110011111111111111111111111111',
                    '0011111111111111111111111111111111111101111111111111111111111111111111111111101111111111111000111111111111111111111011111111110000001111111111111111111111111111111000001111111111111111111111110111111000011111111111111111111111111001111010011111111111111111111111111110011100011111111111111111111111111111100100101111111111111111111111111111111000001111111111111111111111111111111110000111111111111111111111111111111111101011111111111111111111111111',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => '8', 'code' => [
                    '000011111111111111111111111110000111100000001111111111111111111111000000010000000011111111111111111111110000000000111000011111111111111111111000110000011111000111111111111111111110011110001111111001111111111111111111100111100001111110011111111111111111111001111100011111100111111111111111111110001110000011111001111111111111111111100000000000011100111111111111111111111100000011000000001111111111111111111111100001111000000111111111111111111111111111111111000011111111111111',
                    '000011111111111111111111111110100111100000001111111111111111111111000000010000000011111111111111111111110000000000111000011111111111111111111100110000011111000111111111111111111110011110001111111001111111111111111111100111100001111110011111111111111111111001111100011111100111111111111111111110001110000011111001111111111111111111100000000000011100111111111111111111111100000011000000001111111111111111111111100001111000000111111111111111111111111111111111000011111111111111',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
            [
                'value' => '9', 'code' => [
                    '0000011111111111111111111111111111110000000011111001111111111111111111111000000000011111001111111111111111111110001111000011110011111111111111111111000111111000111100111111111111111111110011111111001111001111111111111111111100111111110011110011111111111111111111001111111100111000111111111111111111110001111110011110011111111111111111111110001111000110000111111111111111111111110000000000000011111111111111111111111110000000000001111111111111111111111111111000000011111111111111111',
                    '000011111111111111111111111111111110000000011111001111111111111111111111000000000011111001111111111111111111110001111000011110011111111111111111111000111111000111100111111111111111111110011111111001111001111111111111111111100111111110111111011111111111111111111001111111100111000111111111111111111110001111110011110011111111111111111111110001111000110000111111111111111111111110000000000000011111111111111111111111110000000000001111111111111111111111111111000000011111111111111111',
                    '',
                    '',
                    '',
                    ''
                ]
            ],
        ];
        // var_dump($source);
        $true_codes = [];
        if(count($pic_1) != 4){
            return $this->getHec($imagePath, ++$num, $cookie);
        }
        for ($i = 0; $i < count($pic_1); $i++) {
            $true_codes[$i] = '';
            for ($j = 0; $j < count($source); $j++) {
                for ($k = 0; $k < count($source[$j]['code']); $k++) {
                    if (($source[$j]['code'][$k] != '') && stripos('1' . $pic_1[$i], $source[$j]['code'][$k])) {
                        $true_codes[$i] = $source[$j]['value'];
                        if (($true_codes[$i] == 'l') && (strlen($pic_1[$i]) >= 120)) {
                            $true_codes[$i] = '';
                        }
                        if (($true_codes[$i] == 'r') && (strlen($pic_1[$i]) >= 300)) {
                            $true_codes[$i] = '';
                        }
                        break;
                    }
                }
                if ($true_codes[$i] != '') {
                    break;
                }
            }
            // if($true_codes[$i] == ''){
            //     getHec("http://jw.jxust.edu.cn/verifycode.servlet");
            // }
        }
        if ($true_codes[0] && $true_codes[1] && $true_codes[2] && $true_codes[3]) {
            // echo $num;
            // echo implode('',$true_codes);
            return implode('', $true_codes);
            // for($i = 0 ; $i < count($true_codes) ; $i++){
            //     echo $i+1 . ':' . $true_codes[$i];
            //     echo "&nbsp;" . $pic_1[$i];
            //     echo "<br>";
            // }
        } else {
            if ($num <= 15) {
                return $this->getHec($imagePath, ++$num, $cookie);
            } else {
                throw new MissException(['code' => 502, 'msg' => '验证码识别异常', 'errorCode' => 999]);
            }
        }
    }


    // 已失效的函数
    /**
     * 加密函数
     * @param $plaintext
     * @return string
     */
    private function encodeInp($plaintext)
    {
        $keyStr = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
        $output = "";
        $i = 0;
        while ($i < strlen($plaintext)) {
            $chr1 = intval($this->charCodeAt(substr($plaintext, $i++, 1)));
            $chr2 = intval($this->charCodeAt(substr($plaintext, $i++, 1)));
            $chr3 = intval($this->charCodeAt(substr($plaintext, $i++, 1)));
            $enc1 = $chr1 >> 2;
            $enc2 = (($chr1 & 3) << 4) | ($chr2 >> 4);
            $enc3 = (($chr2 & 15) << 2) | ($chr3 >> 6);
            $enc4 = $chr3 & 63;
            if ($chr2 == -1 && $chr3 == -1) {
                $chr2 = 0;
                $chr3 = 0;
                $enc2 = (($chr1 & 3) << 4) | ($chr2 >> 4);
                $enc3 = $enc4 = 64;
            }
            if ($chr2 !== -1 && $chr3 == -1) {
                $chr3 = 0;
                $enc3 = (($chr2 & 15) << 2) | ($chr3 >> 6);
                $enc4 = 64;
            }
            $output = $output . substr($keyStr, $enc1, 1) . substr($keyStr, $enc2, 1)
                . substr($keyStr, $enc3, 1) . substr($keyStr, $enc4, 1);
            $chr1 = "";
            $chr2 = "";
            $chr3 = "";
            $enc1 = "";
            $enc2 = "";
            $enc3 = "";
            $enc4 = "";
        }
        return $output;
    }


    /**
     * 相当于js中的charCodeAt
     * @param $str
     * @return int|string
     */
    // 已失效函数
    private function charCodeAt($str)
    {
        if ($str == "") {
            return -1;
        }
        $result = array();
        for ($i = 0, $l = mb_strlen($str, "utf-8"); $i < $l; ++$i) {
            $result[] = $this->changeCode(mb_substr($str, $i, 1, "utf-8"));
        }
        return join(",", $result);
    }

    private function changeCode($str)
    {
        $encode = mb_detect_encoding($str, array("ASCII", 'UTF-8', "GB2312", "GBK", 'BIG5'));
        if ($encode !== 'UTF-8') {
            $str = iconv($encode, 'UTF-8', $str);
        }
        if (strlen($str) == 1) {
            return ord($str);
        }
        $str = mb_convert_encoding($str, "UCS-4BE", "UTF-8");
        $tmp = unpack("N", $str);
        return $tmp[1];
    }
}
